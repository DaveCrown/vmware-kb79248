---
- hosts: "{{ sso_domain | default('all') }}"
  gather_facts: yes
  become: no
  serial: 1
  #strategy: debug

  vars:
    script_urls:
      checksts: https://kb.vmware.com/sfc/servlet.shepherd/version/download/068f400000HW9InAAL
      fixsts: https://kb.vmware.com/sfc/servlet.shepherd/version/download/068f400000HnqyiAAB

  tasks:
    - name: checksts
      include_role:
        name: check_sts
      when: sts_role == 'all'  or sts_role =='master'

    - name: Output results 
      debug:
        msg: "STS Certs are Valid"
      when: check_sts_results.stdout is regex("0\ EXPIRED\ CERTS")

    - name: Output results 
      debug:
        msg: "Expired Certs Found"
      when: check_sts_results.stdout is regex("[1-9]\d*\ EXPIRED\ CERTS")

    - name: Output verbose results 
      debug:
        var: check_sts_results.stdout_lines
        verbosity: 1

    - name: set run_script varible
      set_fact:
        run_fix: yes
      when:
        - check_sts_results.stdout is regex("[1-9]\d*\ EXPIRED\ CERTS")
        - fix_sts | default(False)

    - name: Run fixsts.sh script
      include_role:
        name: fix_sts
      when: 
      - run_fix | default(false)
      - sts_role == 'all' or sts_role == 'master'

    - name: restart services on all/master sts
      include_role:
        name: restart_services
      when:
       - run_fix | default(false)
       - sts_role == restart_group
      with_items: "{{ restart_order }}"
      loop_control:
        loop_var: restart_group

